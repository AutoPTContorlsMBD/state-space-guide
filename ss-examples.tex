\section{State-space model examples}

\subsection{Elevator}

\subsubsection{Equations of motion}

The elevator in question consists of a DC brushed motor attached to a pulley
that drives a mass up or down.

\begin{equation}
  V = IR + \frac{\omega_m}{K_v} \label{eq:elevator_V}
\end{equation}

where $V$ is the voltage applied to the motor, $I$ is the current through the
motor in Amps, $R$ is the resistance across the motor in Ohms, $\omega_m$ is the
angular velocity of the motor in radians per second, and $K_v$ is a
proportionality constant.

\begin{equation}
  \tau_m = K_t I \label{eq:elevator_tau_m}
\end{equation}

where $\tau_m$ is the torque produced by the motor in Newton-meters and $K_t$ is
the torque constant in Newton-meters per Amp.

\begin{equation}
  \tau_m G = \tau_p \label{eq:elevator_tau_m_ratio}
\end{equation}

where $G$ is the gear ratio between the motor and the pulley and $\tau_p$ is the
torque produced by the pulley.

\begin{equation}
  rF_m = \tau_p \label{eq:elevator_torque_pulley}
\end{equation}

where $r$ is the radius of the pulley. From equation (\ref{eq:elevator_tau_m}):

\begin{equation}
  I = \frac{\tau_m}{K_t}
\end{equation}
\\
Substitute this into equation (\ref{eq:elevator_V}).

\begin{align*}
  V &= \frac{\tau_m}{K_t} R + \frac{\omega_m}{K_v} \\
  V &= \frac{\tau_m}{K_t} R + \frac{\omega_m}{K_v}
\end{align*}
\\
Substitute in equation (\ref{eq:elevator_tau_m}).

\begin{align*}
  V &= \frac{\frac{\tau_p}{G}}{K_t} R + \frac{\omega_m}{K_v} \\
  V &= \frac{\tau_p}{GK_t} R + \frac{\omega_m}{K_v}
\end{align*}
\\
Substitute in equation (\ref{eq:elevator_torque_pulley}).

\begin{equation}
  V = \frac{rF_m}{GK_t} R + \frac{\omega_m}{K_v} \label{eq:elevator_Vinter1}
\end{equation}
\\
Find $\omega_m$.

\begin{align}
  \omega_m &= G \omega_p \label{eq:elevator_omega_m_ratio} \\
  v_m &= r \omega_p \nonumber
\end{align}
\\
where $v_m$ is the velocity of the mass (the elevator carriage).

\begin{equation}
  \omega_p = \frac{v_m}{r} \label{eq:elevator_omega_p}
\end{equation}
\\
where $\omega_p$ is the angular velocity of the pulley. Substitute equation
(\ref{eq:elevator_omega_p}) into equation (\ref{eq:elevator_omega_m_ratio}).

\begin{equation}
  \omega_m = G \frac{v_m}{r} \label{eq:elevator_omega_m}
\end{equation}
\\
Substitute equation (\ref{eq:elevator_omega_m}) into equation
(\ref{eq:elevator_Vinter1}).

\begin{align*}
  V &= \frac{rF_m}{GK_t} R + \frac{G \frac{v_m}{R}}{K_v} \\
  V &= \frac{RrF_m}{GK_t} + \frac{G}{RK_v} v_m
\end{align*}

Solve for $F_m$.

\begin{align}
  \frac{RrF_m}{GK_t} &= V - \frac{G}{RK_v} v_m \nonumber \\
  F_m &= \left(V - \frac{G}{RK_v} v_m\right) \frac{GK_t}{Rr} \nonumber \\
  F_m &= \frac{GK_t}{Rr} V - \frac{G^2K_t}{R^2 rK_v} v_m \label{eq:elevator_F_m}
\end{align}

\begin{equation}
  \sum F = ma_m \label{eq:elevator_F_ma}
\end{equation}
\\
where $\sum F$ is the sum of forces applied to the elevator carriage, $m$ is
the mass of the elevator carriage in kilograms, and $a_m$ is the acceleration of
the elevator carriage.

\begin{align}
  ma_m &= F_m \nonumber
\end{align}
\\
Note that gravity is not part of the modeled dynamics because it complicates the
state-space model and the controller will behave well enough without it.

\begin{align}
  ma_m &= \left(\frac{GK_t}{Rr} V - \frac{G^2K_t}{R^2 rK_v} v_m\right)
    \nonumber \\
  a_m &= \frac{GK_t}{Rrm} V - \frac{G^2K_t}{R^2 rmK_v} v_m
    \label{eq:elevator_accel}
\end{align}
\\
\subsubsection{Calculating DC brushed motor constants}

Note that a typical motor's datasheet should include graphs of the motor's
measured torque and current for different angular velocities for a given voltage
applied to the motor.

$G$, $r$, and $m$ are given when designing the elevator.

\begin{align}
  \tau_m &= I K_t \nonumber \\
  K_t &= \frac{\tau_m}{I} \nonumber \\
  K_t &= \frac{\tau_{m,stall}}{I_{stall}}
\end{align}
\\
where $\tau_{m,stall}$ is the stall torque and $I_{stall}$ is the stall current
of the motor from its datasheet. \\

Recall equation (\ref{eq:elevator_V}).

\begin{equation*}
  V = IR + \frac{\omega_m}{K_v}
\end{equation*}
\\
When the motor is stalled, $\omega_m = 0$.

\begin{align}
  V &= I_{stall} R \nonumber \\
  R &= \frac{V}{I_{stall}}
\end{align}
\\
where $I_{stall}$ is the stall current of the motor and $V$ is the voltage
applied to the motor at stall. \\

Again recall equation (\ref{eq:elevator_V}).

\begin{equation*}
  V = IR + \frac{\omega_m}{K_v}
\end{equation*}
\\
When the motor is spinning under no load, no current is drawn so $I = 0$.

\begin{align}
  V &= \frac{\omega_m}{K_v} \nonumber \\
  K_v &= \frac{V}{\omega_{m,free}}
\end{align}
\\
where $\omega_{m,free}$ is the angular velocity of the motor under no load (also
known as the free speed) and $V$ is the voltage applied to the motor when
it's spinning at $\omega_{m,free}$.

\subsubsection{Continuous state-space model}

The position and velocity of the elevator can be written as

\begin{align}
  \dot{x}_m &= v_m \label{eq:elevator_cont_ss_pos} \\
  \dot{v}_m &= a_m \label{eq:elevator_cont_ss_vel}
\end{align}
\\
where from equation (\ref{eq:elevator_accel})

\begin{equation*}
  a_m = \frac{GK_t}{Rrm} V - \frac{G^2 K_t}{R^2 rm K_v} v_m
\end{equation*}
\\
Substitute this into equation (\ref{eq:elevator_cont_ss_vel}).

\begin{align}
  \dot{v}_m &= \frac{GK_t}{Rrm} V - \frac{G^2 K_t}{R^2 rm K_v} v_m \nonumber \\
  \dot{v}_m &= -\frac{G^2 K_t}{R^2 rm K_v} v_m + \frac{GK_t}{Rrm} V
\end{align}

\begin{align*}
  \dot{\mtx{x}} &= \mtx{A} \mtx{x} + \mtx{B} \mtx{u} \\
  \dot{\mtx{y}} &= \mtx{C} \mtx{x} + \mtx{D} \mtx{u}
\end{align*}

\begin{align*}
  \dot{\mtx{x}} &= \left[
  \begin{array}{c}
    x \\
    v_m
  \end{array}
  \right] \\
  \mtx{y} &= x \\
  \mtx{u} &= V
\end{align*}

\begin{align}
  \dot{\mtx{x}} &= \left[
  \begin{array}{cc}
    0 & 1 \\
    0 & -\frac{K_t G^2}{R^2rmK_v}
  \end{array}
  \right] \left[
  \begin{array}{c}
    x \\
    v_m \\
  \end{array}
  \right] + \left[
  \begin{array}{c}
    0 \\
    \frac{GK_t}{Rrm}
  \end{array}
  \right] V \\
  \mtx{y} &= \left[
  \begin{array}{cc}
    1 & 0
  \end{array}
  \right] \left[
  \begin{array}{c}
    x \\
    v_m \\
  \end{array}
  \right] + 0 \cdot V
\end{align}

\subsubsection{Discrete state-space model}

The position and velocity of the elevator can be written as

\begin{align}
  x_{m,k+1} &= x_{m,k} + v_{m,k} \Delta t \label{eq:elevator_disc_ss_pos} \\
  v_{m,k+1} &= v_{m,k} + a_{m,k} \Delta t \label{eq:elevator_disc_ss_vel}
\end{align}
\\
where from equation (\ref{eq:elevator_accel})

\begin{equation*}
  a_{m,k} = \frac{GK_t}{Rrm} V_k - \frac{G^2 K_t}{R^2 rm K_v} v_{m,k}
\end{equation*}
\\
Substitute this into equation (\ref{eq:elevator_disc_ss_vel}).

\begin{align}
  v_{m,k+1} &= v_{m,k} + \left(\frac{GK_t}{Rrm} V_k -
    \frac{G^2 K_t}{R^2 rm K_v} v_{m,k}\right) \Delta t \nonumber \\
  v_{m,k+1} &= v_{m,k} + \frac{GK_t}{Rrm} \Delta t V_k -
    \frac{G^2 K_t}{R^2 rm K_v} \Delta t v_{m,k} \nonumber \\
  v_{m,k+1} &= v_{m,k} - \frac{G^2 K_t}{R^2 rm K_v} \Delta t v_{m,k} +
    \frac{GK_t}{Rrm} \Delta t V_k \nonumber \\
  v_{m,k+1} &= \left(1 - \frac{G^2 K_t}{R^2 rm K_v} \Delta t\right) v_{m,k} +
    \frac{GK_t}{Rrm} \Delta t V_k
\end{align}

\begin{align*}
  \mtx{x}_{k+1} &= \mtx{A} \mtx{x}_k + \mtx{B} \mtx{u}_k \\
  \mtx{y}_{k+1} &= \mtx{C} \mtx{x}_k + \mtx{D} \mtx{u}_k
\end{align*}

\begin{align*}
  \mtx{x}_k &= \left[
  \begin{array}{c}
    x_k \\
    v_{m,k}
  \end{array}
  \right] \\
  \mtx{y}_k &= x_k \\
  \mtx{u}_k &= V_k
\end{align*}

\begin{align}
  \mtx{x}_{k+1} &= \left[
  \begin{array}{cc}
    1 & \Delta t \\
    0 & 1 - \frac{K_t G^2}{R^2rmK_v} \Delta t
  \end{array}
  \right] \left[
  \begin{array}{c}
    x_k \\
    v_{m,k} \\
  \end{array}
  \right] + \left[
  \begin{array}{c}
    0 \\
    \frac{GK_t}{Rrm} \Delta t
  \end{array}
  \right] V_k \\
  \mtx{y}_{k+1} &= \left[
  \begin{array}{cc}
    1 & 0
  \end{array}
  \right] \left[
  \begin{array}{c}
    x_k \\
    v_k \\
  \end{array}
  \right] + 0 \cdot V_k
\end{align}
